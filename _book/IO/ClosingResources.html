<!DOCTYPE HTML>
<html lang="en-US">
    <head prefix="og: http://ogp.me/ns# book: http://ogp.me/ns/book#">
        
        <meta charset="UTF-8">
        <title>关闭资源ClosingResources | Learn Guava</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="robots" content="index, follow">
        <meta name="author" content="xionglie">
        <meta name="description" content="笔记的大部分翻译内容来源于以下">
        <meta name="keywords" content="gitbook,github" >
        <meta name="generator" content="www.gitbook.io">

        
        <link rel="next" href="../IO/Files.html" />
        
        
        <link rel="prev" href="../IO/README.html" />
        

        <meta property="og:title" content="关闭资源ClosingResources | Learn Guava">
        <meta property="og:site_name" content="Learn Guava">
        <meta property="og:type" content="book">
        <meta property="og:locale" content="en_US">

        <meta property="book:author" content="https://github.com/xionglie">
        <meta property="book:tag" content="GitBook">

        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    </head>
    <body>
        

        <link rel="stylesheet" href="../gitbook/style.css">
        


        
    <div class="book" data-github="xionglie/note-learning-guava" data-level="9.1" data-basepath=".." data-revision="1399366736245">
    <div class="book-header">
    <!-- Actions Left -->
    
    <a href="https://github.com/xionglie/note-learning-guava" target="_blank" class="btn pull-left"><i class="fa fa-github-alt"></i></a>
    
    <a href="#" class="btn pull-left toggle-summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
	<div class="dropdown-caret">
  <span class="caret-outer"></span>
  <span class="caret-inner"></span>
</div>

	<div class="btn-group btn-block">
		<button id="reduce-font-size" class="btn btn-default">A</button>
		<button id="enlarge-font-size" class="btn btn-default">A</button>
	</div>

	<ul class="list-group font-family-list">
		<li class="list-group-item" data-font="0">Serif</li>
		<li class="list-group-item" data-font="1">Sans</li>
	</ul>

	<div class="btn-group btn-group-xs btn-block color-theme-list">
	  <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
	  <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
	  <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
	</div>
</div>

    </span>

    <!-- Actions Right -->
    <a href="#" target="_blank" class="btn pull-right" data-sharing="google-plus"><i class="fa fa-google-plus"></i></a>
    <a href="#" target="_blank" class="btn pull-right" data-sharing="facebook"><i class="fa fa-facebook"></i></a>
    <a href="#" target="_blank" class="btn pull-right" data-sharing="twitter"><i class="fa fa-twitter"></i></a>

    
    <a href="https://github.com/xionglie/note-learning-guava/stargazers" target="_blank" class="btn pull-right count-star"><i class="fa fa-star-o"></i> Star (<span>-</span>)</a>
    <a href="https://github.com/xionglie/note-learning-guava/watchers" target="_blank" class="btn pull-right count-watch"><i class="fa fa-eye"></i> Watch (<span>-</span>)</a>
    

    <!-- Title -->
    <h1><a href="../" >Learn Guava</a></h1>
</div>

    <div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        <li>
            <a href="https://github.com/xionglie" target="blank">About the author</a>
        </li>
        <li>
            <a href="https://github.com/xionglie/note-learning-guava/issues" target="blank">Questions and Issues</a>
        </li>
        <li>
            <a href="https://github.com/xionglie/note-learning-guava/edit/master/IO/ClosingResources.md" target="blank">Edit and Contribute</a>
        </li>
        <li class="divider"></li>
        
        <li data-level="0" data-path="index.html">
            <a href="../"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
            <li  data-level="1" data-path="BasicUtilities/README.html">
                
                <a href="../BasicUtilities/README.html">
                    <i class="fa fa-check"></i> <b>1.</b> 基本工具 Basic Utilities
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="1.1" data-path="BasicUtilities/UsingAndAvoidingNull.html">
                            
                            <a href="../BasicUtilities/UsingAndAvoidingNull.html">
                                <i class="fa fa-check"></i> <b>1.1.</b> Using and avoiding null
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.2" data-path="BasicUtilities/Preconditions.html">
                            
                            <a href="../BasicUtilities/Preconditions.html">
                                <i class="fa fa-check"></i> <b>1.2.</b> Preconditions
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.3" data-path="BasicUtilities/Ordering.html">
                            
                            <a href="../BasicUtilities/Ordering.html">
                                <i class="fa fa-check"></i> <b>1.3.</b> Ordering
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.4" data-path="BasicUtilities/ObjectCommonUtilities.html">
                            
                            <a href="../BasicUtilities/ObjectCommonUtilities.html">
                                <i class="fa fa-check"></i> <b>1.4.</b> Object common methods
                            </a>
                            
                        </li>
                    
                        <li  data-level="1.5" data-path="BasicUtilities/Throwables.html">
                            
                            <a href="../BasicUtilities/Throwables.html">
                                <i class="fa fa-check"></i> <b>1.5.</b> Throwables
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li  data-level="2" data-path="Collections/README.html">
                
                <a href="../Collections/README.html">
                    <i class="fa fa-check"></i> <b>2.</b> 集合 Collections
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="2.1" data-path="Collections/ImmutableCollections.html">
                            
                            <a href="../Collections/ImmutableCollections.html">
                                <i class="fa fa-check"></i> <b>2.1.</b> Immutable collections
                            </a>
                            
                        </li>
                    
                        <li  data-level="2.2" data-path="Collections/NewCollectionTypes.html">
                            
                            <a href="../Collections/NewCollectionTypes.html">
                                <i class="fa fa-check"></i> <b>2.2.</b> New Collection Types
                            </a>
                            
                        </li>
                    
                        <li  data-level="2.3" data-path="Collections/UtilityClasses.html">
                            
                            <a href="../Collections/UtilityClasses.html">
                                <i class="fa fa-check"></i> <b>2.3.</b> Utility Classes
                            </a>
                            
                        </li>
                    
                        <li  data-level="2.4" data-path="Collections/ExtensionUtilities.html">
                            
                            <a href="../Collections/ExtensionUtilities.html">
                                <i class="fa fa-check"></i> <b>2.4.</b> Extension Utilities
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li  data-level="3" data-path="Caches/README.html">
                
                <a href="../Caches/README.html">
                    <i class="fa fa-check"></i> <b>3.</b> 缓存[Caches]
                </a>
                
                
            </li>
        
            <li  data-level="4" data-path="FunctionalIdioms/README.html">
                
                <a href="../FunctionalIdioms/README.html">
                    <i class="fa fa-check"></i> <b>4.</b> 函数式风格[Functional idioms]
                </a>
                
                
            </li>
        
            <li  data-level="5" data-path="Concurrency/README.html">
                
                <a href="../Concurrency/README.html">
                    <i class="fa fa-check"></i> <b>5.</b> 并发[Concurrency]
                </a>
                
                
            </li>
        
            <li  data-level="6" data-path="Strings/README.html">
                
                <a href="../Strings/README.html">
                    <i class="fa fa-check"></i> <b>6.</b> 字符串处理[Strings]
                </a>
                
                
            </li>
        
            <li  data-level="7" data-path="Primitives/README.html">
                
                <a href="../Primitives/README.html">
                    <i class="fa fa-check"></i> <b>7.</b> 原生类型[Primitives]
                </a>
                
                
            </li>
        
            <li  data-level="8" data-path="Ranges/README.html">
                
                <a href="../Ranges/README.html">
                    <i class="fa fa-check"></i> <b>8.</b> 区间[Ranges]
                </a>
                
                
            </li>
        
            <li  data-level="9" data-path="IO/README.html">
                
                <a href="../IO/README.html">
                    <i class="fa fa-check"></i> <b>9.</b> I/O
                </a>
                
                
                <ul class="articles">
                    
                        <li  data-level="9.1" data-path="IO/ClosingResources.html">
                            
                            <a href="../IO/ClosingResources.html">
                                <i class="fa fa-check"></i> <b>9.1.</b> 关闭资源ClosingResources
                            </a>
                            
                        </li>
                    
                        <li  data-level="9.2" data-path="IO/Files.html">
                            
                            <a href="../IO/Files.html">
                                <i class="fa fa-check"></i> <b>9.2.</b> Files类常用方法
                            </a>
                            
                        </li>
                    
                </ul>
                
            </li>
        
            <li  data-level="10" data-path="Hash/README.html">
                
                <a href="../Hash/README.html">
                    <i class="fa fa-check"></i> <b>10.</b> 散列[Hash]
                </a>
                
                
            </li>
        
            <li  data-level="11" data-path="EventBus/README.html">
                
                <a href="../EventBus/README.html">
                    <i class="fa fa-check"></i> <b>11.</b> 事件总线[EventBus]
                </a>
                
                
            </li>
        
            <li  data-level="12" data-path="Math/README.html">
                
                <a href="../Math/README.html">
                    <i class="fa fa-check"></i> <b>12.</b> 数学运算[Math]
                </a>
                
                
            </li>
        
            <li  data-level="13" data-path="Reflection/README.html">
                
                <a href="../Reflection/README.html">
                    <i class="fa fa-check"></i> <b>13.</b> 反射[Reflection]
                </a>
                
                
            </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 95.83333333333333%;min-width: 91.66666666666667%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="../BasicUtilities/README.html" title="基本工具 Basic Utilities" class="chapter done new-chapter" data-progress="1" style="left: 4.166666666666667%;"></a>
    
        <a href="../BasicUtilities/UsingAndAvoidingNull.html" title="Using and avoiding null" class="chapter done " data-progress="1.1" style="left: 8.333333333333334%;"></a>
    
        <a href="../BasicUtilities/Preconditions.html" title="Preconditions" class="chapter done " data-progress="1.2" style="left: 12.5%;"></a>
    
        <a href="../BasicUtilities/Ordering.html" title="Ordering" class="chapter done " data-progress="1.3" style="left: 16.666666666666668%;"></a>
    
        <a href="../BasicUtilities/ObjectCommonUtilities.html" title="Object common methods" class="chapter done " data-progress="1.4" style="left: 20.833333333333332%;"></a>
    
        <a href="../BasicUtilities/Throwables.html" title="Throwables" class="chapter done " data-progress="1.5" style="left: 25%;"></a>
    
        <a href="../Hash/README.html" title="散列[Hash]" class="chapter done " data-progress="10" style="left: 29.166666666666668%;"></a>
    
        <a href="../EventBus/README.html" title="事件总线[EventBus]" class="chapter done " data-progress="11" style="left: 33.333333333333336%;"></a>
    
        <a href="../Math/README.html" title="数学运算[Math]" class="chapter done " data-progress="12" style="left: 37.5%;"></a>
    
        <a href="../Reflection/README.html" title="反射[Reflection]" class="chapter done " data-progress="13" style="left: 41.666666666666664%;"></a>
    
        <a href="../Collections/README.html" title="集合 Collections" class="chapter done new-chapter" data-progress="2" style="left: 45.833333333333336%;"></a>
    
        <a href="../Collections/ImmutableCollections.html" title="Immutable collections" class="chapter done " data-progress="2.1" style="left: 50%;"></a>
    
        <a href="../Collections/NewCollectionTypes.html" title="New Collection Types" class="chapter done " data-progress="2.2" style="left: 54.166666666666664%;"></a>
    
        <a href="../Collections/UtilityClasses.html" title="Utility Classes" class="chapter done " data-progress="2.3" style="left: 58.333333333333336%;"></a>
    
        <a href="../Collections/ExtensionUtilities.html" title="Extension Utilities" class="chapter done " data-progress="2.4" style="left: 62.5%;"></a>
    
        <a href="../Caches/README.html" title="缓存[Caches]" class="chapter done new-chapter" data-progress="3" style="left: 66.66666666666667%;"></a>
    
        <a href="../FunctionalIdioms/README.html" title="函数式风格[Functional idioms]" class="chapter done new-chapter" data-progress="4" style="left: 70.83333333333333%;"></a>
    
        <a href="../Concurrency/README.html" title="并发[Concurrency]" class="chapter done new-chapter" data-progress="5" style="left: 75%;"></a>
    
        <a href="../Strings/README.html" title="字符串处理[Strings]" class="chapter done new-chapter" data-progress="6" style="left: 79.16666666666667%;"></a>
    
        <a href="../Primitives/README.html" title="原生类型[Primitives]" class="chapter done new-chapter" data-progress="7" style="left: 83.33333333333333%;"></a>
    
        <a href="../Ranges/README.html" title="区间[Ranges]" class="chapter done new-chapter" data-progress="8" style="left: 87.5%;"></a>
    
        <a href="../IO/README.html" title="I/O" class="chapter done new-chapter" data-progress="9" style="left: 91.66666666666667%;"></a>
    
        <a href="../IO/ClosingResources.html" title="关闭资源ClosingResources" class="chapter done " data-progress="9.1" style="left: 95.83333333333333%;"></a>
    
        <a href="../IO/Files.html" title="Files类常用方法" class="chapter  " data-progress="9.2" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_1">
                    
                        <h1 id="-closingresources">关闭资源ClosingResources</h1>
<p><a href="https://code.google.com/p/guava-libraries/wiki/ClosingResourcesExplained" target="_blank">https://code.google.com/p/guava-libraries/wiki/ClosingResourcesExplained</a></p>
<h1 id="closing-resources">Closing Resources</h1>
<p>Closing Closeable resources properly when finished with them is important for ensuring that socket connections are closed, file descriptors are not leaked, etc. as well as for ensuring correct program behavior. Pre-JDK7, it&#39;s extremely difficult to do properly, with many pitfalls that may not be immediately obvious. It&#39;s notoriously almost never done correctly, even within the JDK itself.</p>
<p>Here&#39;s an example of some typical code to open, use and close an InputStream in JDK6:</p>
<pre><code class="lang-java">InputStream in = <span class="hljs-keyword">null</span>;
<span class="hljs-keyword">try</span> {
  in = openInputStream();
  <span class="hljs-comment">// do something with in</span>
} <span class="hljs-keyword">finally</span> {
  <span class="hljs-keyword">if</span> (in != <span class="hljs-keyword">null</span>) {
    in.close();
  }
}
</code></pre>
<p>This code, while far more complicated than we&#39;d like, is about as simple as you can get using standard JDK APIs. Unfortunately, even it has a problem: if an exception is thrown inside the try block and then an exception is thrown when calling in.close() in the finally block, the exception from the try block will be swallowed by the exception thrown in finally and you won&#39;t see the details of that error or even get any indication that it occurred at all!</p>
<p>It gets much, much worse if there are two streams that must be open at the same time:</p>
<pre><code class="lang-java">InputStream in = <span class="hljs-keyword">null</span>;
<span class="hljs-keyword">try</span> {
  in = openInputStream();
  OutputStream out = <span class="hljs-keyword">null</span>;
  <span class="hljs-keyword">try</span> {
    out = openOutputStream();
    <span class="hljs-comment">// do something with in and out</span>
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (out != <span class="hljs-keyword">null</span>) {
      out.close();
    }
  }
} <span class="hljs-keyword">finally</span> {
  <span class="hljs-keyword">if</span> (in != <span class="hljs-keyword">null</span>) {
    in.close();
  }
}
</code></pre>
<p>The nested try/finally blocks here are extremely unreadable, and the code still has the same issues with exceptions as above.</p>
<h3 id="input-vs-output-streams">Input vs. output streams</h3>
<p>There&#39;s an important difference between input and output streams when it comes to closing resources.</p>
<p>With input stream, an error that occurs when attempting to close the stream is unlikely to be significant to your program: you&#39;re done with it, you&#39;ve read everything you need.</p>
<p>With output streams, exceptions thrown when closing the stream must be treated as just as significant as exceptions thrown when actually using the stream. The reason for this is that output streams may buffer data that is written to them and need to flush buffered data to the underlying output sink when close() is called. In other words, the close() call may be triggering an actual write to a file or other sink, so an exception thrown from that call may indicate actual failure to complete the intended write operations.</p>
<h1 id="solutions">Solutions</h1>
<h3 id="try-with-resources">try-with-resources</h3>
<p>If you&#39;re using JDK7, this is easy: use try-with-resources. Here&#39;s an example of opening and closing multiple resources using try-with-resources:</p>
<pre><code class="lang-java"><span class="hljs-keyword">try</span> (InputStream in = openInputStream();
     OutputStream out = openOutputStream()) {
  <span class="hljs-comment">// do stuff with in and out</span>
}
</code></pre>
<p>Both streams will automatically be closed at the end of the try block, and if multiple exceptions are thrown, the first exception thrown will suppress the other two, and the stack traces of all the exceptions will be present in the single exception thrown from the try block. It&#39;s easy, it fixes all the problems, use it!</p>
<h3 id="sources-and-sinks">Sources and Sinks</h3>
<p>ByteSource and CharSource represent readable sources of binary and character data, respectively. ByteSink and CharSink represent writable sinks for binary and character data, respectively. All should be able to open multiple independent streams (e.g. InputStream or Writer) for reading from or writing to them.</p>
<p>When possible, creating an implementation of one of these types (or using a provided implementation such as Files.asByteSource(File)) allows you to circumvent the problem of opening and closing streams entirely by allowing you to use methods on those classes that handle opening and closing the resource for you. For example, you can copy the contents of a File to some ByteSink using the following:</p>
<pre><code class="lang-java">ByteSink sink = ...
Files.asByteSource(file).copyTo(sink);
</code></pre>
<h1 id="closer">Closer</h1>
<p>Closer is a new class added to Guava in release 14.0. It&#39;s intended as a poor man&#39;s try-with-resources block for code that must compile and run under JDK6. Here&#39;s an example of using it:</p>
<pre><code class="lang-java">Closer closer = Closer.create();
<span class="hljs-keyword">try</span> {
  InputStream in = closer.register(openInputStream());
  OutputStream out = closer.register(openOutputStream());
  <span class="hljs-comment">// do stuff with in and out</span>
} <span class="hljs-keyword">catch</span> (Throwable e) { <span class="hljs-comment">// must catch Throwable</span>
  <span class="hljs-keyword">throw</span> closer.rethrow(e);
} <span class="hljs-keyword">finally</span> {
  closer.close();
}
</code></pre>
<p>Calling close() on the Closer will safely close all Closeable objects that have been registered with it. When running under Java 7, it even uses the same mechanism for suppressing additional exceptions that try-with-resources uses, producing behavior that should be identical. Do note that when using Closer, it&#39;s very important to follow the prescribed usage pattern: any Throwable thrown from the block where the Closeable resources are used must be caught and rethrown through Closer&#39;s rethrow method before calling closer.close(). Also note that if you wish to catch any exception thrown from this whole block of code, you should wrap the entire thing in another try block.</p>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../IO/README.html" class="navigation navigation-prev"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../IO/Files.html" class="navigation navigation-next"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        

        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/mode-javascript.js"></script>
        <script src="../gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
        <script src="../gitbook/app.js"></script>
        

    
    <script src="../gitbook/plugins/gitbook-plugin-mixpanel/plugin.js"></script>
    

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

    </body>
</html>
